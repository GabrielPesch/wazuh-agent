run-name: Build Wazuh agent Linux binaries - ${{ inputs.architecture }} - ${{ inputs.source_reference }} - ${{ inputs.id }}
name: Build Wazuh agent Linux binaries

on:
  workflow_call:
    inputs:
      docker_image_tag:
        type: string
        required: false
        default: 'auto'
      architecture:
        type: string
        required: true
      source_reference:
        type: string
        required: true
      id:
        type: string
        required: false

jobs:
  build-binaries-agent-linux:
    runs-on: ${{ (inputs.architecture == 'arm64' || inputs.architecture == 'aarch64') && 'wz-linux-arm64' || 'ubuntu-latest' }}
    timeout-minutes: 50
    name: Build Linux wazuh-agent sources - ${{ inputs.architecture }}

    steps:
      - name: Checkout the wazuh-agent repository
        uses: actions/checkout@v4
        with:
          repository: wazuh/wazuh-agent
          ref: ${{ inputs.source_reference }}
          persist-credentials: false

      - name: Set ARCH, TAG and DOCKER_IMAGE_NAME
        uses: ./.github/actions/docker_set_arch_tag_and_image_name
        with:
          system: rpm
          architecture: ${{ inputs.architecture }}
          docker_image_tag: ${{ inputs.docker_image_tag }}
          source_reference: ${{ inputs.source_reference }}

      - name: Fetch needed Docker image
        uses: ./.github/actions/docker_pull_image
        with:
          gh_user: ${{ github.actor}}
          gh_token: ${{ github.token}}
          docker_image_name: ${{ env.DOCKER_IMAGE_NAME }}
          docker_image_tag: ${{ env.TAG }}

      - name: Launch Docker container
        uses: ./.github/actions/docker_run_command
        with:
          docker_image_name: ${{ env.DOCKER_IMAGE_NAME }}
          docker_image_tag: ${{ env.TAG }}
          arguments: -dit -v $(pwd):/wazuh-local-src:rw -e VCPKG_BINARY_SOURCES="clear;nuget,GitHub,readwrite"
          container_name: builder_container

      - name: Configure binary caching inside Docker container
        uses: ./.github/actions/docker_exec_command
        with:
          container_name: builder_container
          commands: bash /wazuh-local-src/.github/actions/vcpkg_related/cover_vcpkg_dependencies/cover_vcpkg_dependencies.sh ${{ github.token}}
          
      - name: Build binaries
        uses: ./.github/actions/docker_exec_command
        with:
          container_name: builder_container
          commands: cd /wazuh-local-src && cmake src -B src/build && cmake --build src/build --parallel $(nproc) && rm -rf src/build/_deps src/build/vcpkg*

      - name: Zip repository
        run: |
          zip -r ${{ github.workspace }}/wazuh-agent-binaries-${{ inputs.architecture }}.zip ${{ github.workspace }}/

      - name: Upload wazuh-agent-binaries.zip
        uses: actions/upload-artifact@v4
        with:
          name: wazuh-agent-binaries-${{ inputs.architecture }}
          path: ${{ github.workspace }}/wazuh-agent-binaries-${{ inputs.architecture }}.zip
